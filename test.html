<html>
<head>
<script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js" integrity="sha256-8E6QUcFg1KTnpEU8TFGhpTGHw5fJqB9vCms3OhAYLqw=" crossorigin="anonymous"></script>
<script>
$(function(){
	if (navigator.geolocation) {
		//Geolocation APIを利用できる環境向けの処理
		navigator.geolocation.getCurrentPosition(
			function(position){
				//success
				var gl_text = "緯度：" + position.coords.latitude + "<br>";
				gl_text += "経度：" + position.coords.longitude + "<br>";
				gl_text += "高度：" + position.coords.altitude + "<br>";
				gl_text += "緯度・経度の誤差：" + position.coords.accuracy + "<br>";
				gl_text += "高度の誤差：" + position.coords.altitudeAccuracy + "<br>";
				gl_text += "方角：" + position.coords.heading + "<br>";
				gl_text += "速度：" + position.coords.speed + "<br>";
				document.getElementById("show_result").innerHTML = gl_text;


				var url = 'https://maps.googleapis.com/maps/api/geocode/json?latlng=%LAT%,%LNG%&key=AIzaSyDkGbtUCNtY8DG7sGQ6s-LZVn-ndeaGF40';
				url = url
					.replace('%LAT%', position.coords.latitude)
					.replace('%LNG%', position.coords.longitude)
				
				$.ajax({
					url: url,
					dataType: 'json',
				}).success(function(data) {
					console.log(data);

					for(var i=0; i<data.results.length; i++){
						$('<p />')
							.text(data.results[i].formatted_address)
							.appendTo('#reverse_result')
					}

					var filtered = _.find(data.results, function(o){
						return _.isEqual(o.types.sort(), [ "political", "sublocality", "sublocality_level_3" ].sort())
					});
					console.warn(filtered);

					var targetAddress = _.find(filtered.address_components, function(o){
						return _.isEqual(o.types.sort(), [ "political", "administrative_area_level_1" ].sort()) //東京都
					}).long_name
					+
					_.find(filtered.address_components, function(o){
						return _.isEqual(o.types.sort(), [ "political", "locality" ].sort()) // xx区
					}).long_name
					+
					_.find(filtered.address_components, function(o){
						return _.isEqual(o.types.sort(), [ "political", "sublocality", "sublocality_level_1" ].sort()) // ○○
					}).long_name;
					

					// x丁目のデータは入っていないことがある（東京都千代田区紀尾井町とかはx丁目という表記がない）
					var sublocality_level_2 = _.find(filtered.address_components, function(o){
						return _.isEqual(o.types.sort(), [ "political", "sublocality", "sublocality_level_2" ].sort()) // x丁目
					})
					if(sublocality_level_2){
						targetAddress += sublocality_level_2.long_name;
					}
					console.warn(targetAddress)

					//地震に関する地域危険度測定調査（第7回）地域危険度一覧(平成25年9月公表)
					$.ajax({
						url: "https://script.google.com/macros/s/AKfycbwZQ0HfF0S1QzYxXn4KVPy1hgNBfIftdu24Gmu0s4ykY1YzkiDc/exec",
						dataType: 'json',
					}).success(function(regionalHazardLevelData) {
						// console.warn(regionalHazardLevelData)
						var hazardLevelData = _.find(regionalHazardLevelData, function(o){
							return o.key == targetAddress
						})
						console.warn(hazardLevelData);

						var dataKeyToId ={
							"建物倒壊危険度 ランク": "collapseHazardRank",
							"建物倒壊危険度 順位": "collapseHazardRating",
							"火災危険度 ランク": "fireHazardRank",
							"火災危険度 順位": "fireHazardRating",
							"総合危険度 ランク": "totalHazardRank",
							"総合危険度 順位": "totalHazardRating",
						}
						for(var dataKey in dataKeyToId){
							console.log( hazardLevelData[dataKey] )
							$('#'+dataKeyToId[dataKey]).text(hazardLevelData.data[dataKey])
						}
						$("#hazardResult").show();
					});

				}).error(function(data) {
					alert('error!!!');
				});
			},
			function(){
				//error
			}
		);
	} else {
		//Geolocation APIを利用できない環境向けの処理
	}
})
</script>
<style type="text/css">
#hazardResult{
	display: none;
}
</style>
</head>
<body>
	<p>result</p>
	<p id="show_result"></p>
	<div id="reverse_result"></div>

	<div id="hazardResult">
		<p>危険度データ</p>
		<table>
			<tr>
				<th>建物倒壊危険度 ランク</th>
				<td id="collapseHazardRank"></td>
			</tr>
			<tr>
				<th>建物倒壊危険度 順位</th>
				<td id="collapseHazardRating"></td>
			</tr>
			<tr>
				<th>火災危険度 ランク</th>
				<td id="fireHazardRank"></td>
			</tr>
			<tr>
				<th>火災危険度 順位</th>
				<td id="fireHazardRating"></td>
			</tr>
			<tr>
				<th>総合危険度 ランク</th>
				<td id="totalHazardRank"></td>
			</tr>
			<tr>
				<th>総合危険度 順位</th>
				<td id="totalHazardRating"></td>
			</tr>
		</table>
	</div>
</body>
</html>